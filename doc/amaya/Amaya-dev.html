<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Writing source code for Amaya</title>
  <meta name="GENERATOR" content="amaya V2.5">
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
</head>

<body lang="en">
<p><a href="../../"><img border="0" alt="W3C"
src="../../Icons/WWW/w3c_home"></a><a href="../"><img border="0"
src="../Icons/amaya.gif" alt="Amaya"></a></p>

<h1 style="font-size: 24pt; text-align: center">Writing source code for
Amaya</h1>

<p style="text-align: center"><em>September 1999</em></p>

<p>This document is intended to help writing source code in Amaya. It concerns
file names, variables, function signatures, etc.</p>

<h2>Files location</h2>

<p>The root directory is called <strong>Amaya</strong> and includes 11
sub-directories. The libwww is stored in a separated hierarchy and its root
directory <strong>libwww</strong> must be a sibling of the Amaya root
directory.</p>

<p><img src="../Icons/Sources.gif" alt="Amaya folder"></p>
<ul>
  <li>the directory <strong>amaya</strong> includes source files of the Amaya
    application: c code (.c), common structures and variables ( h). A
    sub-directory f includes function signatures (_f.h files are automatically
    generated by "make proto" on Unix platforms).</li>
  <li>the directory <strong>batch</strong> includes the source of Thot
    compilers.</li>
  <li>the directories <strong>libjpeg</strong>, <strong>libpng</strong>,
    <strong>pluginlib</strong>, <strong>tablelib</strong> include the source
    code of related libraries.</li>
  <li>as the <strong>thotlib</strong> is a large piece of code the source code
    is ranged into several sub-directories.
    <ul>
      <li>the sub-directory <strong>base</strong> collects basic modules
        (memory allocation, registry, file access).</li>
      <li>the sub-directory <strong>content</strong> collects text management
        modules.</li>
      <li>the sub-directory <strong>dialogue</strong> collects all UI
      modules.</li>
      <li>the sub-directory <strong>document</strong> collects modules which
        manage Thot documents.</li>
      <li>the sub-directory <strong>editing</strong> collects editing
      modules.</li>
      <li>the sub-directory <strong>image</strong> collects image
      drivers.</li>
      <li>the sub-directory <strong>include</strong> collects external Thotlib
        declarations.</li>
      <li>the sub-directory <strong>internals</strong> collects internal
        Thotlib declarations. There are 3 different sub-directory:
        <ul>
          <li><strong>h</strong>: for global structure types and
          constants,</li>
          <li><strong>var</strong>: for global variables. Files are noted
            <code>_tv.h</code> and their inclusion should be preceded by a
            definition of THOT_EXPORT
            <p><code>#DEFINE THOT_EXPORT</code></p>
            <p>or</p>
            <p><code>#DEFINE THOT_EXPORT extern</code></p>
          </li>
          <li><strong>f</strong>: for function declarations. Files are noted
            <code>_f.h</code>.</li>
        </ul>
      </li>
      <li>the sub-directory <strong>presentation</strong> collects modules
        which manage document styles.</li>
      <li>the sub-directory <strong>tree</strong> collects modules which
        manipulate document tree structures (Abstract Trees) and
      attribute.</li>
      <li>the sub-directory <strong>view</strong> collects modules which
        manage document view (Abstract Boxes and Boxes).</li>
    </ul>
  </li>
  <li>the directory <strong>tools</strong> includes the source code of
    building applications which allows us to generate file dependencies ("make
    dep") or or to generate function prototypes( "make proto").</li>
</ul>

<h2>Types declaration</h2>

<p>To avoid conflicts with included libraries and to share the code as often
as possible, the Thot library  defines its own types for booleans, widgets,
buttons, pixmaps and windows. All these declarations are located in files
Amaya/thotlib/include/thot_sys.h, Amaya/thotlib/include/thot_gui.h  and
Amaya/thotlib/include/thot_uio.h. See also <a href="Unicode-dev.html">Unicode
conventions</a>.</p>

<p>We recommand to organize modules in five clearly separated sections:</p>
<ol>
  <li>A global comment which gives the COPYRIGHT, the role of the module and
    the list of its authors.</li>
  <li>A section that declares all  types used in the module. It is often a
    list of includes.</li>
  <li>A section that declares the variables used in the module. It is a list
    of includes preceded by the definition of the macro THOT_EXPORT. Static
    variables of the module must be declared in this section too.</li>
  <li>A section that declares external functions used in the module. It is a
    list of includes.</li>
  <li>The core section of the module.</li>
</ol>

<h2>Notations</h2>

<p>That concerns local variables, global variables, function headings and
function names.</p>
<ul>
  <li><em>Local variables:</em>
    <p>Local variables and function parameters must start with a lowercase
    character.</p>
  </li>
  <li><em>Global variables:</em>
    <p>Global variables must start with a uppercase character. When they are
    global but only used into one module. They must be declared
    <code>static</code> in that module. When they are used in more than one
    module they must be declared in a included file:</p>
    <ul>
      <li>in the Thotlib code, they are declared into one of the files<br>
        <code>Amaya/thotlib/internals/var/*tv.h</code></li>
      <li>in the Amaya code, they are stored in include file
        <code>Amaya/amaya/*h</code></li>
    </ul>
  </li>
  <li><em>Function headings</em>:
    <p>All functions should include a comment at the top which explains what
    the function does, what is the signification of parameters, what is the
    output.</p>
    <p>A function must be declared <code>static</code> if it is only used into
    the current module.</p>
    <p>Function declarations must be done  according to both the new standard
    C and the old C convention.</p>
    <p>By example:</p>
    <pre>/*----------------------------------------------------------------------
  GetStyleContents returns a buffer that contains the whole text of the
  style element el. It returns NULL if the element is empty.
  The buffer should be freed by the caller.
  ----------------------------------------------------------------------*/
#ifdef __STDC__
STRING              GetStyleContents (Element el)
#else /* __STDC__ */
Element             el;
#endif /* __STDC__ */
{
...
}
    </pre>
  </li>
  <li><em>Function names</em>:
    <p>A function name must start with a uppercase character and more if it
    includes different words.</p>
    <p>There are specific conventions for functions which are exported by the
    Thotlib.</p>
    <dl>
      <dt><strong>Tta</strong>XXX</dt>
        <dd>is the name of an API function. It should be documented in
          APIman.html.</dd>
      <dt><strong>Ttc</strong>XXX</dt>
        <dd>is the name of a Thot standard command. It has 2 parameters: the
          document and the view even if one of these parameters is not used by
          the function. That function can be used by the application interface
          (see the file <code>Amaya/amaya/EDITOR.A</code>) like  the command
          <strong>CloseView</strong> which uses
        <code>TtcCloseView</code>.</dd>
      <dt>TteXXX</dt>
        <dd>is the name of a Thotlib function which manages Thot events. That
          function cannot be used freely.</dd>
    </dl>
  </li>
</ul>

<h2><a name="Adding">Adding a new dialogue</a></h2>

<p>Adding a new dialogue entry in any Amaya menu is by by several steps:</p>
<ol>
  <li>Editing the file Amaya/amaya/EDITOR.A</li>
  <li>Writing the called function with the right signature: (the Document
    parameter and the View parameter).</li>
  <li>Compile the Amaya code and check the position of the new dialogue in the
    generated file Amaya/obj/amaya/EDITOR.h</li>
  <li>Add the corresponding entry at the right place in dialogue files<code>
    Amaya/config/*-amayadialogue</code> (one for each supported languages).
    It's not necessary to renumber all following entries in these dialogue
    files. We have a tool to do that (step 5).</li>
  <li>Go into the directory<code> Amaya/config/</code> and execute the command
    <code>rescandialogue</code> on each edited dialogue files to recompute
    entry number. This command is compiled and installed in your
    <code>Amaya/obj/bin directory</code>.</li>
  <li>Update the file of Amaya profiles <code>Amaya/config/ProfileDefs</code>
    to make that function available in right profiles.</li>
  <li>Update the section <strong>Keyboard Shortcuts</strong> in the file
    <code>Amaya/doc/amaya/Configure.html</code> if that function should be
    acceded by a shortcut.</li>
</ol>

<h2>Translating Amaya into other languages</h2>

<h3>Background</h3>

<p>In Amaya, we distinguish the following types of dialogues:</p>
<dl>
  <dt>Menu dialogues (MD)</dt>
    <dd>These are the messages shown in the Menu bar and in the submenus.</dd>
  <dt>Message box dialogues (MBD)</dt>
    <dd>These are the dialogues that are shown in the pop up windows</dd>
  <dt>Status bar messages (SBM)</dt>
    <dd>These are the messages that are shown in the Amaya status bar (bottom
      of the screen)</dd>
  <dt>Thot tools messages (TTM)</dt>
    <dd>These are the messages displayed on the standard output while
      compiling Amaya with the thot tools.</dd>
</dl>

<p>Under Unix, all these messages are stored in files found in the
<code>Amaya/config</code> directory. Under Windows, the Message box dialogues
are stored in a resource file and must be edited directly using the Visual C++
resource editor.</p>

<p>Each line in a message file has the following message:</p>

<p><code>message-num space message-text</code></p>

<p><code>message-num </code>is the number used in the Amaya source code to
reference the message. Another file in the <code>Amaya/amaya</code> directory
makes a relationship between the message-num and a symbolic name. It is thru
this symbolic name that a message dialogue is actually referenced in the Amaya
source code.<br>
<code>message-text </code>is the text itself. Note that the text should be a
single line. In particular, carry returns in the message text are not
tolerated. The message-text may be used asis, or it may be used as the format
argument for the  C <code>language sprintf</code> function.</p>

<p>The following table lists all the amaya dialogue files, their type, and
cites any related file (<em>incomplete, needs more prunning</em>)</p>

<table border="1">
  <caption></caption>
  <tbody>
    <tr>
      <td>filename (<code>Amaya/config</code> dir)</td>
      <td>type</td>
      <td>related files (<code>Amaya/amaya</code> dir)</td>
    </tr>
    <tr>
      <td>*-amayadialogue</td>
      <td>MD</td>
      <td>EDITOR.A,</td>
    </tr>
    <tr>
      <td>*-amayamsg</td>
      <td>MBD</td>
      <td>amayamsg.h</td>
    </tr>
    <tr>
      <td>*-appdialogue</td>
      <td>TTM</td>
      <td></td>
    </tr>
    <tr>
      <td>*-compildialogue</td>
      <td>TTM</td>
      <td></td>
    </tr>
    <tr>
      <td>*-corrdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-drawdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-grmdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-inddialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-javamsg</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-libdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-printdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-prsdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-strdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-thotdialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-tradialogue</td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>*-transdialogue</td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>

<p>where * represents a language, such as en for English, fr for French, de
for German, and so on.</p>

<h3>Adding a new language</h3>
<ol>
  <li>cd to the <code>Amaya/config</code> directory.</li>
  <li>Copy all the files named <code>en-* </code>into your own language code,
    for example,<code> </code><code>de-*</code> for German, .<code>it-*</code>
    for Italian, ....
    <p>You can do it so using the follow shell script and by adding your
    target language code (de, it, ...):</p>
    <p><code>ls -d en-* | sed "s/en-\(.*\)/cp &amp; target_language_code-\1/"
    | sh</code></p>
  </li>
  <li>Open your new files and translate each message to the new language. Be
    careful of respecting the sense of the text (whether it is a C sprintf
    format string or a text message. If the original message has three
    trailing points, for example, Setup and Print..., this means that this is
    a menu entry which will open up a PopUp window. You need to keep those
    trailing points in your translation</li>
</ol>

<p>TIP: In order to be able to place the context of each dialogue message,
it's useful to look at the related files and have Amaya running at the same
time.</p>

<h1>Adding a new Help menu entry</h1>

<p>Help menu entries are handled as dialogue entries. Therefore, you'll have
to add a new dialogue entry, a callback procedure, connect this procedure to
the dialogue entry, and make this procedure open the related manual page</p>

<p>Follow the instructions for <a href="#Adding">adding a new dialogue
entry</a>, inspiring yourself from the existing help menu entries. For
example, the Help/Configure entry is defined as follows in the EDITOR.A
file:</p>
<pre>      view:1 Help_ button:BHelpConfigure -> HelpConfigure;</pre>

<p>The callback procedure and the definition of the manual pages are done in
the <code>init.c</code> file. To associate a manual page to the procedure, you
first need to declare it in the helpmenu.h file. In this find, you'll find an
array called Manual and some macro definitions to associate a names with the
Manual entries. For HelpConfigure, the macro is called
<code>CONFIGURE</code>.</p>

<p>Once you've done this, open the init file, search for the Help* procedures
and add your new procedure. For example, HelpConfigure is specified as
follows:</p>
<pre>/*----------------------------------------------------------------------
  -----------------------------------------------------------------------*/
 #ifdef __STDC__ 
void HelpConfigure (Document document, View view)
#else /* __STDC__*/
void HelpConfigure (document, view)
      Document document;
      View view;
#endif /* __STDC__*/
{
   DisplayHelp (document, CONFIGURE);
}</pre>

<p>The DisplayHelp function will open a new document window and show the
document specified in the Manual index (file <code>helpmenu.h</code>). Note
that we use the macro rather than the index number to refer to the index
entry.</p>
</body>
</html>
