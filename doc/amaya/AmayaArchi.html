<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Draft//EN">
<HTML>
<HEAD>
<META name="author" content="V. Quint">
<TITLE>Amaya architecture</TITLE>
</HEAD>
<BODY>
<H1 align=center>The Amaya Architecture</H1>

<H2>Abstract</H2>

<P>
Amaya is a large piece of software. If you want to change it or extend it in
some way, you may experiment some difficulty in finding out the right part to
be modified in the code. The purpose of this note is to help you understand
the Amaya architecture and find your way in the source code.</P>
<H2>Contents</H2>

<P>
<A href="#L464"><STRONG>1 Architecture</STRONG></A></P>
<P>
<A href="#L465">1.1 Document representations</A></P>
<P>
<A href="#L466">1.2 Software components</A></P>
<P>
<A href="#L467"><STRONG>2 Changing and extending Amaya</STRONG></A></P>
<P>
<A href="#L495">2.1 Changing menu bars and pull-down menus</A></P>
<P>
<A href="#L468">2.2 Changing the button bar</A></P>
<P>
<A href="#L469">2.3 Changing default document presentation</A></P>
<P>
<A href="#L470">2.4 Creating new views</A></P>
<P>
<A href="#L471">2.5 Adding new HTML tags and attributes</A></P>
<P>
<A href="#L472">2.6 Modifying existing commands</A></P>
<P>
<A href="#L473">2.7 Creating new editing commands</A></P>
<P>
<A href="#L555">2.8 Adding new structure transformations</A></P>
<P>
<A href="#L596">2.9 Configuring Amaya</A></P>
<H2><A name="L464">1 Architecture</A></H2>

<P>
Amaya is an application based on Thot. Thot is a generic tool kit intended to
build document based applications, with a structured approach to the document
model. Basically, Thot provides a set of document manipulations functions with
an API and allows applications to include additional functions through a
callback mechanism. It can also includes a simple declarative language to
generate the user interface of an application.</P>
<H3><A name="L465">1.1 Document representations</A></H3>

<P>
Different document representations are maintained or generated by Amaya:</P>
<DL>
<DT>Document structure and contents</DT>
<DD>Each document is represented by a <EM>tree</EM> within Amaya. This tree
represents the document structure. Its leaves contain the actual text. You can
see a visual representation of that tree in the Structure view. This tree
structure is constrained by some rules that are specified in a Thot
<EM>structure schema</EM> (file <CODE>HTML.S</CODE> in directory
<CODE>amaya</CODE>), written in the S language (see the <A
href="http://opera.inrialpes.fr/thot/languages.html">language manual</A>).
<P>
Names of element types and attributes in file <CODE>HTML.S</CODE> are not
those that the user actually sees on the screen. Correspondence between
internal and external names is given by file <CODE>HTML.en</CODE> in directory
<CODE>amaya</CODE>.</P>
</DD>
<DT>Document presentation and views</DT>
<DD>The internal tree structure only represents the logical structure of HTML
documents. The graphical aspect of these documents is specified by a Thot
<EM>presentation schema</EM> (file <CODE>HTMLP.P</CODE> in directory
<CODE>amaya</CODE>), written in the P language (see the <A
href="http://opera.inrialpes.fr/thot/languages.html">language manual</A>).
<P>
The presentation schema specifies all possible views of HTML documents and the
aspect of these documents in each view. It also specify how documents should
be formatted for printing.</P>
<P>
Amaya uses a single source file (<CODE>HTMLP.P</CODE>) to specify different
presentation schemas, using conditional compilation (see variables
<CODE>PAGE</CODE>, <CODE>BLACK_WHITE</CODE>, <CODE>US_PAPER</CODE>).</P>
</DD>
<DT>HTML output</DT>
<DD>While editing, Amaya works on the internal tree structure. HTML files are
produced only when saving a document. Then, the tree structure is written in
the output file according to a Thot <EM>translation schema</EM> (file
<CODE>HTMLT.T</CODE> in directory <CODE>amaya</CODE>), written in the T
language (see the <A
href="http://opera.inrialpes.fr/thot/languages.html">language manual</A>).
</DD>
</DL>
<H3><A name="L466">1.2 Software components</A></H3>

<P>
The main software components involved in Amaya are the following:</P>
<DL>
<DT>Graphical user interface</DT>
<DD>The Amaya user interface contains three types of widgets:
<UL>
<LI>A <STRONG>menu bar</STRONG>, at the top of each document window
<P>
This bar and all its menus, including cascading menus, are specified in a Thot
<EM>application schema</EM> (file <CODE>EDITOR.A</CODE> in directory
<CODE>amaya</CODE>) written in the A language (see the <A
href="http://opera.inrialpes.fr/thot/Appman.toc.html">A language
manual</A>).</P>
<LI>A <STRONG>button bar</STRONG> below the menu bar, in the formatted view.
<P>
This button bar is created by Amaya at initialization time (see function
<CODE>InitDocView</CODE> in module <CODE>amaya/init.c</CODE>).</P>
<LI>Various <STRONG>dialogue boxes</STRONG>
<P>
Some of these dialogue boxes are standard Thot dialogue boxes, other are
created by the Amaya application. Both Thot and Amaya use the Thot dialogue
module.</P>
</UL>
</DD>
<DT>Standard Thot editing functions</DT>
<DD>A number of basic editing functions are simply <A
href="http://opera.inrialpes.fr/thot/Appman.html#secta3">standard Thot
functions</A>. The name of these functions start with <CODE>Ttc</CODE>.
</DD>
<DT>Specific editing functions</DT>
<DD>In addition to the standard functions, Amaya has its own editing
functions.
<UL>
<LI>Some functions are called from the <STRONG>menu bar</STRONG> (see file
<CODE>EDITOR.A</CODE> in directory <CODE>amaya</CODE>) and are implemented in
the C modules of directory <CODE>amaya</CODE>.
<LI>Some functions are called from the <STRONG>button bar</STRONG> (see
function <CODE>InitDocView</CODE> in module <CODE>amaya/init.c</CODE>) and are
also implemented in the C modules of directory <CODE>amaya</CODE>.
<LI>Some functions are called from standard Thot editing commands. They are
defined in file <CODE>HTML.A</CODE> (directory <CODE>amaya</CODE>) and
implemented in the C modules of directory <CODE>amaya</CODE>. They implement
some specific treatments that are required for tables, pictures, forms, style
sheets, etc.
</UL>
</DD>
<DT>HTML Parsing</DT>
<DD>HTML files are parsed by module <CODE>html2thot.c</CODE> (directory
<CODE>amaya</CODE>), which builds the internal tree structure.
</DD>
<DT>CSS parsing</DT>
<DD>Style sheets and CSS syntax in general are parsed by module
<CODE>HTMLstyle.c.</CODE>
</DD>
<DT>Structure transformation</DT>
<DD>Structure transformation commands are handled by two modules:
<CODE>trans.c</CODE> and <CODE>transparse.c</CODE>. These modules are driven
by the <CODE>HTML.trans</CODE> file (directory <CODE>amaya</CODE>), which
specifies the possible transformations.
</DD>
</DL>
<H2><A name="L467">2 Changing and extending Amaya</A></H2>

<P>
A number of modifications to Amaya can be made without modifying the C code.
As explained above, the behavior of Amaya is defined by a number of schemas
and other files that can be modified easily, as they are written in very
simple declarative languages. Prior to making any change to the source code,
it's worth considering modifications to these files.</P>
<H3><A name="L495">2.1 Changing menu bars and pull-down menus</A></H3>

<P>
You may want to change the user interface. The simplest change you can make is
modifying the menu bars and the pull-down menus.</P>
<P>
There is a menu bar on top of each window handled by Amaya. Notice that the
contents of these menu bars vary according to the view displayed in the
window.</P>
<P>
All menu bars and the corresponding pull-down menus are defined in file
<CODE>EDITOR.A</CODE> (directory <CODE>amaya</CODE>). Update that file for
defining your own menu bars (it is written in the A language, which is
documented in <EM>The Thot Application Generation Language</EM>). Then, you
just have to <CODE>make amaya</CODE>.</P>
<P>
If you want the new (or existing) menus and their items to be available in
different languages, don't forget to update the <CODE>xx-amayadialogue</CODE>
file (in directory <CODE>config</CODE>), where <CODE>xx</CODE> is the language
name (for instance, <CODE>en</CODE> for English or <CODE>fr</CODE> for
French).</P>
<H3><A name="L468">2.2 Changing the button bar</A></H3>

<P>
You can change the button bar of the formatted view in many ways. You can</P>
<UL>
<LI>remove buttons (most of them are equivalent to some menu item),
<LI>change their order,
<LI>change their icon,
<LI>add new buttons.
</UL>
<P>
For all these changes, you have to edit the function <CODE>InitDocView</CODE>
in module <CODE>amaya/init.c</CODE> and to <CODE>make amaya</CODE>.</P>
<H3><A name="L469">2.3 Changing default document presentation</A></H3>

<P>
Document style can be changed in many ways. In a document, stylistic
information can be associated with a given element, with all elements of a
given type, with all elements having the same <CODE>class</CODE> attribute,
etc. You can do that with the Style menu (refer to the <A
href="Manual.html">user's manual</A>), but you may want to change the default
presentation of all documents displayed by Amaya. There are two ways to do
that:</P>
<DL>
<DT>Using a personal style sheet</DT>
<DD>Create a file <CODE>.amaya.css</CODE> in your home directory or edit it if
it exists. This file is written in the CSS1 language.
<P>
When the file is updated you don't need to do anything else. The next document
you load or reload will be displayed with the new style sheet.</P>
<P>
These changes only apply to the Formatted view of the documents <EM>you</EM>
display.</P>
</DD>
<DT><A name="L491">Changing the presentation schema used by Amaya</A></DT>
<DD>Edit the <CODE>HTMLP.P</CODE> presentation schema in directory
<CODE>amaya</CODE>. This file is written in the P language (see the <A
href="http://opera.inrialpes.fr/thot/languages.html">Thot language
manual</A>). By editing this file, you may modify the appearance of all
documents in any view.
<P>
When the file is updated, you need to compile it with the <STRONG>prs</STRONG>
compiler, but typing <CODE>make amaya</CODE> in the <CODE>amaya</CODE>
directory does the job.</P>
<P>
Changes made that way apply to all documents displayed or edited by all users
sharing the same installation of Amaya, but style sheets supersede the
presentation schema.</P>
<P>
The presentation schema specifies document presentation on the screen as well
as on the paper. To change the layout of printed documents, including page
headers and footers, with numbers, running headings, etc., focus on the parts
that follow conditions <CODE>#ifdef PAGE</CODE> in the schema.</P>
</DD>
</DL>
<H3><A name="L470">2.4 Creating new views</A></H3>

<P>
You may create new views by editing and compiling file <CODE>HTMLP.P</CODE>
(see <A href="#L491">above</A>), but this is not enough. You must also edit
file <CODE>EDITOR.A</CODE> to add a new item to the Views menu (see <A
href="#L495">above</A>). This item is associated with a C function that you
must create in file <CODE>init.c</CODE>. You can use functions
<CODE>ShowStructure</CODE> and <CODE>ShowAlternate</CODE> as examples.</P>
<P>
You may specify the default position and size of the view in file
<CODE>HTML.conf</CODE>.</P>
<P>
Just <CODE>make amaya</CODE> when all these changes have been made.</P>
<H3><A name="L471">2.5 Adding new HTML tags and attribute</A></H3>

<P>
To experiment an HTML extension, you must update several files:</P>
<DL>
<DT>HTML.S</DT>
<DD>Declare the new element type or attribute in the structure schema
<CODE>HTML.S</CODE>. If you want the external name of the new element or
attribute to be different in different languages, update the files
<CODE>HTML.xx</CODE>, where <CODE>xx</CODE> is the name of the language.
</DD>
<DT>HTMLP.P</DT>
<DD>Specify the default presentation of the new element or attribute in the
presentation schema <CODE>HTMLP.P</CODE>. Don't forget to specify the
presentation in all views. For the Structure view, some new presentation boxes
will probably be needed.
</DD>
<DT>HTMLT.T</DT>
<DD>Specify the corresponding HTML syntax in the translation schema
<CODE>HTMLT.T</CODE>.
</DD>
<DT>EDITOR.A</DT>
<DD>If it's a new element, add an item to the Types menu or to one of its
submenus, to allow the user to create these elements. The new menu item will
call a function that you must also write. This function is very simple in most
cases (refer to functions corresponding to existing menu items in module
<CODE>EDITORactions.c</CODE>).
<P>
If it's an attribute, the Attributes menu will be updated automatically.</P>
</DD>
<DT>html2thot.c</DT>
<DD>To allow Amaya to parse the new tag or attribute, you must update the HTML
parser. HTML elements and attributes are declared in tables at the beginning
of module <CODE>html2thot.c</CODE>, as well as the corresponding element or
attribute defined in the structure schema <CODE>HTML.S</CODE>. In most cases,
updating these tables is enough.
</DD>
</DL>
<P>
If the new element or attribute needs some extension to standard editing
commands or some new editing commands, see the next two sections.</P>
<H3><A name="L472">2.6 Modifying existing commands</A></H3>

<P>
You can modify Thot standard commands or Amaya specific commands.</P>
<P>
File <CODE>HTML.A</CODE> specifies all extensions and replacements for Thot
standard editing commands. You can modify the functions implementing these
extensions and replacements. You can also specify additional such functions,
by editing file <CODE>HTML.A</CODE> and writing the code implementing the new
functions.</P>
<P>
Amaya specific editing functions are those referred to in file
<CODE>EDITOR.A</CODE>. They are implemented in the C modules of directory
<CODE>amaya</CODE>. You can obviously change these implementations.</P>
<H3><A name="L473">2.7 Creating new editing commands</A></H3>

<P>
To create new commands, you have to define their user interface (add a <A
href="#L495">new menu</A> to a menu bar, a <A href="#L495">new item</A> to an
existing menu and/or a <A href="#L468">new button</A> to the button bar) and
to write the code of the corresponding function.</P>
<H3><A name="L555">2.8 Adding new structure transformations</A></H3>

<P>
The last item of the Types menu allows you to transform the structure of the
selected elements. When activating that item, you get another menu that
presents the choice of the possible transformations.</P>
<P>
To offer new transformations, you have to specify them in the
<CODE>HTML.trans</CODE> file (directory <CODE>amaya</CODE>). You don't need to
do anything else (no compilation, no make). The menu of the possible
transformations will be updated automatically, according to the current
selection and the new contents of the <CODE>HTML.trans</CODE> file.</P>
<H3><A name="L596">2.9 Configuring Amaya</A></H3>

<P>
Users can cofigure Amaya in various ways, just by editing some configuration
files. This is described in the document <A
href="Configure.html"><EM>Configuring Amaya</EM></A>.</P>
<P>
</P>
<HR>
<ADDRESS>
<P>
<A href="mailto:quint@w3.org">V. Quint<BR></A>$Date$</P>
</ADDRESS>
</BODY>
</HTML>
